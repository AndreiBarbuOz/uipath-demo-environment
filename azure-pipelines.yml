variables:
- group: demo-vm-deploy

trigger:
- master
- andrei
- stefan

stages:
- stage: Build
  displayName: Build and Test
  jobs:
  - job: validate
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - task: AzureResourceGroupDeployment@2
      displayName: validate lab template
      inputs:
        azureSubscription: $(testAzureConnection)
        #action: 'Create Or Update Resource Group' # Options: create Or Update Resource Group, select Resource Group, start, stop, stopWithDeallocate, restart, delete, deleteRG
        resourceGroupName: $(testResourceGroupName)
        #location: # Required when action == Create Or Update Resource Group
        templateLocation: 'Linked artifact' # Options: linked Artifact, uRL Of The File
        #csmFileLink: # Required when templateLocation == URL Of The File
        #csmParametersFileLink: # Optional
        csmFile: $(Build.SourcesDirectory)/lab/azuredeploy.json # Required when  TemplateLocation == Linked Artifact
        csmParametersFile: $(Build.SourcesDirectory)/lab/azuredeploy.parameters.json # Optional
        #overrideParameters: # Optional
        deploymentMode: 'Validation' # Options: Incremental, Complete, Validation
        #enableDeploymentPrerequisites: 'None' # Optional. Options: none, configureVMwithWinRM, configureVMWithDGAgent
        #teamServicesConnection: # Required when enableDeploymentPrerequisites == ConfigureVMWithDGAgent
        #teamProject: # Required when enableDeploymentPrerequisites == ConfigureVMWithDGAgent
        #deploymentGroupName: # Required when enableDeploymentPrerequisites == ConfigureVMWithDGAgent
        #copyAzureVMTags: true # Optional
        #runAgentServiceAsUser: # Optional
        #userName: # Required when enableDeploymentPrerequisites == ConfigureVMWithDGAgent && RunAgentServiceAsUser == True
        #password: # Optional
        #outputVariable: # Optional
        #deploymentName: # Optional
        #deploymentOutputs: # Optional
        #addSpnToEnvironment: false # Optional

    - task: AzureResourceGroupDeployment@2
      displayName: validate vm template
      inputs:
        azureSubscription: $(testAzureConnection)
        #action: 'Create Or Update Resource Group' # Options: create Or Update Resource Group, select Resource Group, start, stop, stopWithDeallocate, restart, delete, deleteRG
        resourceGroupName: $(testResourceGroupName)
        #location: # Required when action == Create Or Update Resource Group
        templateLocation: 'Linked artifact' # Options: linked Artifact, uRL Of The File
        #csmFileLink: # Required when templateLocation == URL Of The File
        #csmParametersFileLink: # Optional
        csmFile: $(Build.SourcesDirectory)/vm/azuredeploy.json # Required when  TemplateLocation == Linked Artifact
        csmParametersFile: $(Build.SourcesDirectory)/vm/azuredeploy.parameters.json # Optional
        #overrideParameters: # Optional
        deploymentMode: 'Validation' # Options: Incremental, Complete, Validation
        #enableDeploymentPrerequisites: 'None' # Optional. Options: none, configureVMwithWinRM, configureVMWithDGAgent
        #teamServicesConnection: # Required when enableDeploymentPrerequisites == ConfigureVMWithDGAgent
        #teamProject: # Required when enableDeploymentPrerequisites == ConfigureVMWithDGAgent
        #deploymentGroupName: # Required when enableDeploymentPrerequisites == ConfigureVMWithDGAgent
        #copyAzureVMTags: true # Optional
        #runAgentServiceAsUser: # Optional
        #userName: # Required when enableDeploymentPrerequisites == ConfigureVMWithDGAgent && RunAgentServiceAsUser == True
        #password: # Optional
        #outputVariable: # Optional
        #deploymentName: # Optional
        #deploymentOutputs: # Optional
        #addSpnToEnvironment: false # Optional

    - task: AzureResourceGroupDeployment@2
      displayName: validate env template
      inputs:
        azureSubscription: $(testAzureConnection)
        #action: 'Create Or Update Resource Group' # Options: create Or Update Resource Group, select Resource Group, start, stop, stopWithDeallocate, restart, delete, deleteRG
        resourceGroupName: $(testResourceGroupName)
        #location: # Required when action == Create Or Update Resource Group
        templateLocation: 'Linked artifact' # Options: linked Artifact, uRL Of The File
        #csmFileLink: # Required when templateLocation == URL Of The File
        #csmParametersFileLink: # Optional
        csmFile: $(Build.SourcesDirectory)/env/PresalesDemo/azuredeploy.json # Required when  TemplateLocation == Linked Artifact
        csmParametersFile: $(Build.SourcesDirectory)/env/PresalesDemo/azuredeploy.parameters.json # Optional
        #overrideParameters: # Optional
        deploymentMode: 'Validation' # Options: Incremental, Complete, Validation
        #enableDeploymentPrerequisites: 'None' # Optional. Options: none, configureVMwithWinRM, configureVMWithDGAgent
        #teamServicesConnection: # Required when enableDeploymentPrerequisites == ConfigureVMWithDGAgent
        #teamProject: # Required when enableDeploymentPrerequisites == ConfigureVMWithDGAgent
        #deploymentGroupName: # Required when enableDeploymentPrerequisites == ConfigureVMWithDGAgent
        #copyAzureVMTags: true # Optional
        #runAgentServiceAsUser: # Optional
        #userName: # Required when enableDeploymentPrerequisites == ConfigureVMWithDGAgent && RunAgentServiceAsUser == True
        #password: # Optional
        #outputVariable: # Optional
        #deploymentName: # Optional
        #deploymentOutputs: # Optional
        #addSpnToEnvironment: false # Optional
  